# This workflow is triggered when a GitHub release is created.
# It can also be run manually to re-publish to PyPI in case it failed for some reason.
# You can run this workflow by navigating to https://www.github.com/gitpod-io/gitpod-sdk-python/actions/workflows/publish-pypi.yml
name: Publish PyPI
on:
  workflow_dispatch:

  release:
    types: [published]

jobs:
  publish:
    name: publish
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Install Rye
        uses: eifinger/setup-rye@v4
        with:
          version: '0.44.0'
          
      - name: Sync dependencies
        run: rye sync

      - name: Build package
        run: rye build --clean
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # No token needed! Trusted publishing handles authentication
          packages-dir: dist/
